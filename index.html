Не, мы так в жизни ниче не добьёмся, поэтому меняем решение, вместо того чтобы делать код компактным, вернем код как было в этот, но уже с другими изменениями:
Итак, какое у нас незаконченное дело на сайте из этих кодов можно доделать или исправить ошибки?
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mortis Play — официальный сайт</title>
  <meta name="description" content="Эпичные видео, новости и обновления от Mortis Play. Присоединяйся к вайбу!" />
  <meta name="robots" content="index,follow" />
  <meta name="keywords" content="Mortis Play, гейминг, стримы, YouTube, Telegram" />
  <link rel="icon" href="/images/favicon.ico" />

  <!-- Open Graph -->
  <meta property="og:title" content="Mortis Play — официальный сайт" />
  <meta property="og:description" content="Эксклюзивы, новости и клипы." />
  <meta property="og:image" content="https://mortisplay.ru/assets/og-image.jpg" />
  <meta property="og:url" content="https://mortisplay.ru" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ru_RU" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Mortis Play — официальный сайт" />
  <meta name="twitter:description" content="Эксклюзивы, новости и клипы." />
  <meta name="twitter:image" content="https://mortisplay.ru/assets/twitter-image.jpg" />

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-W7QBLDDSSK"></script>
  <script>
    const nonce = crypto.getRandomValues(new Uint8Array(16)).reduce((s, b) => s + b.toString(16).padStart(2, '0'), '');
    const script = document.createElement('script');
    script.nonce = nonce;
    script.id = 'gtagScript';
    script.innerHTML = `window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-W7QBLDDSSK', { send_page_view: true });`;
    document.head.appendChild(script);
  </script>

  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://kit.fontawesome.com/b48beda69e.js" crossorigin="anonymous" defer></script>

  <style>
    @keyframes floaty { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
    @keyframes badgePop { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes modalFadeIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes modalFadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.95); } }
    .card-hover { transition: transform .25s ease, box-shadow .25s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgb(0 0 0 / .15), 0 0 12px rgba(147, 51, 234, 0.5); }
    .dark .card-hover:hover { box-shadow: 0 12px 24px rgb(0 0 0 / .3), 0 0 12px rgba(99, 102, 241, 0.6); }
    .fade-in { opacity: 0; transform: translateY(16px); transition: opacity .6s ease, transform .6s ease; }
    .fade-in.is-visible { opacity: 1; transform: none; }
    .glass { backdrop-filter: saturate(160%) blur(8px); background: linear-gradient(180deg, rgb(255 255 255 / .7), rgb(255 255 255 / .55)); }
    .dark .glass { background: linear-gradient(180deg, rgb(17 24 39 / .7), rgb(17 24 39 / .55)); }
    #loader { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #6366f1, #ec4899); }
    .loader-spin { width: 64px; height: 64px; border: 6px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #sidebarMenu { box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
    #sidebarMenu.open { transform: translateX(0); }
    #themeToggle { position: relative; overflow: hidden; background: linear-gradient(45deg, #facc15, #fef08a); border-radius: 0.75rem; padding: 0.5rem; color: #1f2937; }
    .dark #themeToggle { background: linear-gradient(45deg, #1e3a8a, #3b82f6); color: #e5e7eb; }
    #themeToggle::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.4); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.5s ease, height 0.5s ease; }
    #themeToggle:hover::before { width: 200%; height: 200%; }
    #themeToggle i { transition: transform 0.5s ease, opacity 0.5s ease; position: relative; z-index: 1; }
    #themeToggle:hover i { transform: rotate(180deg); opacity: 0.8; }
    #themeToggle .glow { position: absolute; inset: 0; box-shadow: 0 0 12px rgba(255, 255, 255, 0.6); opacity: 0; transition: opacity 0.3s ease; }
    #themeToggle:hover .glow { opacity: 1; }
    .dark #themeToggle .glow { box-shadow: 0 0 12px rgba(99, 102, 241, 0.6); }
    .particle { position: absolute; width: 4px; height: 4px; background: #1f2937; border-radius: 50%; pointer-events: none; z-index: 2; }
    .dark .particle { background: #e5e7eb; }
    .video-filter { transition: all 0.3s ease; }
    .video-filter.active { background: rgba(99, 102, 241, 0.3); transform: scale(1.05); }
    .dark .video-filter.active { background: rgba(99, 102, 241, 0.5); }
    .video-filter.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
    .video-card { transition: opacity 0.3s ease, transform 0.3s ease; }
    .video-card.hidden { opacity: 0; transform: scale(0.95); display: none; }
    .video-card:not(.hidden) { animation: fadeIn 0.3s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .pagination-button { transition: all 0.3s ease; }
    .pagination-button:hover { transform: scale(1.05); }
    .pagination-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .notification { transition: opacity 0.3s ease, transform 0.3s ease; }
    .notification.show { opacity: 1; transform: translateY(0); }
    body { overscroll-behavior: none; }
    main { overflow: auto; min-height: 100vh; }
    .low-performance .card-hover { transition: none; }
    .low-performance .card-hover:hover { transform: none; box-shadow: none; }
    .low-performance .fade-in { transition: none; opacity: 1; transform: none; }
    .low-performance .animate-[floaty_5s_ease-in-out_infinite] { animation: none; }
    .low-performance #videos { display: none; }
    .low-performance .banner-video, .low-performance .banner-quote { display: none; }
    .banner-fallback { display: none; }
    .low-performance .banner-fallback { display: block; }
    .no-animations .fade-in, .no-animations .card-hover, .no-animations .animate-[floaty_5s_ease-in-out_infinite], .no-animations .bg-particles {
      transition: none;
      transform: none;
      opacity: 1;
      animation: none;
    }
    :root { --font-scale: 1; }
    body { font-size: calc(1rem * var(--font-scale)); }
    .text-3xl { font-size: calc(1.875rem * var(--font-scale)); }
    .text-2xl { font-size: calc(1.5rem * var(--font-scale)); }
    .text-sm { font-size: calc(0.875rem * var(--font-scale)); }
    .high-contrast {
      --text-color: #000000;
      --bg-color: #ffffff;
      --link-color: #0000ff;
    }
    .high-contrast.dark {
      --text-color: #ffffff;
      --bg-color: #000000;
      --link-color: #00ff00;
    }
    .high-contrast body {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .high-contrast a {
      color: var(--link-color);
      text-decoration: underline;
    }
    .high-contrast .bg-gradient-to-br,
    .high-contrast .glass,
    .high-contrast .glass-button {
      background: var(--bg-color);
      backdrop-filter: none;
      border: 2px solid var(--text-color);
      color: var(--text-color);
    }
    .high-contrast .card-hover {
      background: var(--bg-color);
      border: 2px solid var(--text-color);
      color: var(--text-color);
    }
    .high-contrast .video-filter.active {
      background: var(--text-color);
      color: var(--bg-color);
      border: 2px solid var(--bg-color);
    }
    .high-contrast .bg-gradient-to-r {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .high-contrast .text-transparent {
      color: var(--text-color);
    }
    .high-contrast .ring-1 {
      border: 2px solid var(--text-color);
    }
    .high-contrast .notification {
      background: var(--bg-color);
      color: var(--text-color);
      border: 2px solid var(--text-color);
    }
    .high-contrast .notification button {
      color: var(--text-color);
      border: 1px solid var(--text-color);
      padding: 0.2rem;
      border-radius: 0.25rem;
    }
    .high-contrast #highContrastToggle {
      border: 2px solid var(--text-color);
      width: 1.5rem;
      height: 1.5rem;
    }
    .high-contrast #highContrastToggle:checked {
      background-color: var(--text-color);
      border-color: var(--bg-color);
    }
    .glass-button {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.75rem;
      color: #ffffff;
      font-weight: 600;
      padding: 0.5rem 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .glass-button:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .glass-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .glass-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }
    .dark .glass-button {
      background: rgba(50, 50, 50, 0.15);
      border-color: rgba(200, 200, 200, 0.2);
      color: #e5e7eb;
    }
    .dark .glass-button:hover {
      background: rgba(50, 50, 50, 0.25);
    }
    .dark .glass-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .dark .glass-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
    }
    @supports not (backdrop-filter: blur(10px)) {
      .glass-button { background: rgba(255, 255, 255, 0.5); box-shadow: none; }
      .dark .glass-button { background: rgba(50, 50, 50, 0.5); }
      #settings, #news { background: rgba(255, 255, 255, 0.2); }
      .dark #settings, .dark #news { background: rgba(17, 24, 39, 0.4); }
    }
    .notification {
      display: none;
      background: rgba(255, 255, 255, 0.9);
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      margin-top: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .notification.show {
      display: flex;
      align-items: center;
      gap: 1rem;
      opacity: 1;
      transform: translateY(0);
    }
    .dark .notification {
      background: rgba(17, 24, 39, 0.9);
      color: #e5e7eb;
      border-color: rgba(255, 255, 255, 0.2);
    }
    .notification button {
      background: none;
      border: none;
      color: #1f2937;
      cursor: pointer;
      font-size: 1rem;
      padding: 0.25rem;
      transition: color 0.3s ease;
    }
    .dark .notification button {
      color: #e5e7eb;
    }
    .notification button:hover {
      color: #6366f1;
    }
    .dark .notification button:hover {
      color: #a5b4fc;
    }
    #settings .notification {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      margin-top: 0;
      z-index: 1000;
      max-width: 320px;
    }
    #settings .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .bg-gradient-to-br {
      background-image: linear-gradient(to bottom right, #fef3c7, #f5f3ff, #dbeafe);
    }
    .dark .bg-gradient-to-br {
      background-image: linear-gradient(to bottom right, #1e1b4b, #312e81, #4c1d95);
    }
    h2, h3 {
      color: #4f46e5;
      background: none;
      -webkit-background-clip: none;
      background-clip: none;
    }
    .dark h2, .dark h3 {
      color: #a5b4fc;
      background: none;
    }
    .high-contrast h2, .high-contrast h3 {
      color: var(--text-color);
      background: none;
    }
    article.card-hover {
      background: linear-gradient(to right, #4f46e5, #9333ea);
      color: #ffffff;
      transition: all 0.3s ease;
    }
    article.card-hover:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 0 12px rgba(147, 51, 234, 0.5);
      transform: translateY(-4px);
    }
    .dark article.card-hover {
      background: linear-gradient(to right, #6366f1, #f472b6);
      color: #e5e7eb;
    }
    .dark article.card-hover:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 0 12px rgba(99, 102, 241, 0.6);
    }
    .high-contrast article.card-hover {
      background: var(--bg-color);
      color: var(--text-color);
      box-shadow: none;
      border: 2px solid var(--text-color);
    }
    #videos, #settings, #news, #contact, #projects, #profile {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      color: #1f2937;
    }
    .dark #videos, .dark #settings, .dark #news, .dark #contact, .dark #projects, .dark #profile {
      background: rgba(17, 24, 39, 0.4);
      color: #e5e7eb;
    }
    .high-contrast #videos, .high-contrast #settings, .high-contrast #news, .high-contrast #contact, .high-contrast #projects, .high-contrast #profile {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .badge { animation: badgePop 0.5s ease forwards; }
    @media (max-width: 640px) {
      .glass-button {
        padding: 0.4rem 0.8rem;
        font-size: calc(0.85rem * var(--font-scale));
        gap: 0.4rem;
      }
      .mt-6 {
        margin-top: 1.5rem;
      }
      #contact .flex-wrap, #welcome .flex-wrap {
        gap: 0.75rem;
      }
      #welcome .lg:grid-cols-2 { grid-template-columns: 1fr; }
      #welcome video, #welcome .banner-fallback { max-width: 100%; height: auto; }
      #welcome .mt-4.lg\:absolute { position: static; margin-top: 1rem; width: 100%; }
      #menuToggle { padding: 0.5rem 0.75rem; font-size: 1rem; }
      .glass { backdrop-filter: none; background: linear-gradient(180deg, rgb(255 255 255 / .9), rgb(255 255 255 / .8)); }
      .dark .glass { background: linear-gradient(180deg, rgb(17 24 39 / .9), rgb(17 24 39 / .8)); }
      .card-hover:hover { transform: none; }
      .animate-[floaty_5s_ease-in-out_infinite] { animation: none; }
      iframe, video, img { max-width: 100%; height: auto; }
      #settings .notification { max-width: 80%; right: 0.5rem; bottom: 0.5rem; }
    }
    @media (min-width: 1024px) {
      header { position: sticky; top: 0; z-index: 50; background: white/80 dark:bg-slate-900/80; }
      nav { height: 4rem; }
      nav a { padding: 0.75rem 1rem; }
      nav a:hover { background: slate-100 dark:bg-slate-800; }
    }
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }
    .no-particles .bg-particles {
      display: none;
    }
    body {
      color: #1f2937;
      background: linear-gradient(to bottom right, #fef3c7, #f5f3ff, #dbeafe);
    }
    .dark body {
      color: #e5e7eb;
      background: linear-gradient(to bottom right, #1e1b4b, #312e81, #4c1d95);
    }
    .text-slate-600 { color: #4b5563; }
    .dark .text-slate-600 { color: #9ca3af; }
    .text-slate-700 { color: #374151; }
    .dark .text-slate-700 { color: #d1d5db; }
    .text-slate-800 { color: #1f2937; }
    .dark .text-slate-800 { color: #e5e7eb; }
    .text-indigo-600 { color: #4f46e5; }
    .dark .text-indigo-600 { color: #a5b4fc; }
    .text-indigo-400 { color: #818cf8; }
    .dark .text-indigo-400 { color: #c7d2fe; }
    .bg-white { background-color: #ffffff; }
    .dark .bg-white { background-color: #1f2937; }
    .bg-slate-50 { background-color: #f8fafc; }
    .dark .bg-slate-50 { background-color: #111827; }
    .bg-slate-800 { background-color: #1f2937; }
    .dark .bg-slate-800 { background-color: #374151; }
    .ring-slate-200 { border-color: #e5e7eb; }
    .dark .ring-slate-200 { border-color: #4b5563; }
    .ring-slate-700 { border-color: #374151; }
    .dark .ring-slate-700 { border-color: #9ca3af; }
  </style>
</head>

<body class="min-h-screen text-slate-800 dark:text-slate-100 selection:bg-indigo-200 selection:text-slate-900">
  <canvas id="backgroundParticles" class="bg-particles"></canvas>
  <div id="loader"><div class="loader-spin" aria-label="Загрузка сайта"></div></div>
  <div id="siteContent" class="hidden">
    <header class="sticky top-0 z-50 border-b border-slate-200/60 dark:border-slate-700/60 bg-white/80 dark:bg-slate-900/80 glass">
      <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between relative" aria-label="Главная навигация">
        <div class="flex items-center gap-2">
          <button id="menuToggle" class="inline-flex sm:hidden items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium ring-1 ring-slate-300/70 dark:ring-slate-600" aria-controls="sidebarMenu" aria-expanded="false">
            <span>Меню</span>
            <i class="fa-solid fa-bars"></i>
          </button>
          <a href="#welcome" class="flex items-center gap-2 font-semibold tracking-tight text-slate-900 dark:text-white">
            <img src="/assets/photo.jpg" alt="Mortis Play Logo" class="h-8 w-8 rounded-lg object-cover" onerror="this.src='/assets/fallback.jpg';">
            <span class="hidden sm:inline">Mortis Play</span>
          </a>
        </div>
        <div class="hidden sm:flex items-center gap-2">
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#welcome">Главная</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#videos">Видео</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#projects">Проекты</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#news">Новости</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#contact">Контакты</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#profile">Профиль</a>
          <a class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#settings">Настройки</a>
        </div>
        <div class="flex items-center gap-2">
          <button id="themeToggle" class="glass-button relative flex items-center gap-1" aria-label="Переключить тему">
            <i class="fa-solid fa-sun"></i>
            <span class="text-xs hidden sm:inline">Светлая</span>
            <div class="glow"></div>
            <canvas id="particleCanvas" class="absolute inset-0 pointer-events-none"></canvas>
          </button>
        </div>
      </nav>
      <div id="sidebarMenu" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-slate-900 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 sm:hidden glass">
        <div class="p-4">
          <button id="closeMenu" class="absolute top-4 right-4 text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white">
            <i class="fa-solid fa-xmark"></i>
          </button>
          <div class="flex items-center gap-2 mb-6">
            <img src="/assets/photo.jpg" alt="Mortis Play Logo" class="h-8 w-8 rounded-lg object-cover" onerror="this.src='/assets/fallback.jpg';">
            <span class="font-semibold tracking-tight text-slate-900 dark:text-white">Mortis Play</span>
          </div>
          <nav class="space-y-2">
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#welcome">Главная</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#videos">Видео</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#projects">Проекты</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#news">Новости</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#contact">Контакты</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#profile">Профиль</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="#settings">Настройки</a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <section id="welcome" class="relative overflow-hidden">
        <div class="absolute top-0 left-0 w-64 h-64 bg-indigo-500/20 rounded-full blur-2xl z-[-1]"></div>
        <div class="absolute top-40 right-0 w-64 h-64 bg-fuchsia-500/20 rounded-full blur-2xl z-[-1]"></div>
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 sm:py-24">
          <div class="grid lg:grid-cols-2 gap-10 items-center">
            <div class="fade-in">
              <h1 class="text-3xl sm:text-5xl font-extrabold tracking-tight leading-tight text-slate-900 dark:text-white">
                Йоу, это <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-fuchsia-600">Mortis Play</span>!
              </h1>
              <p class="mt-4 text-base sm:text-lg text-slate-600 dark:text-slate-300 max-w-prose">
                Эксклюзивные видео, новости и апдейты. Врывайся — дальше только громче 😎
              </p>
              <div class="mt-6 flex flex-wrap gap-3">
                <a href="#contact" class="glass-button" aria-label="Перейти к контактам">
                  <i class="fa-solid fa-envelope"></i>
                  Контакты
                </a>
                <a href="biography.html" class="glass-button" id="bioButton" aria-label="Перейти к биографии">
                  <i class="fa-solid fa-user"></i>
                  Биография
                </a>
                <a id="qaButton" href="qa.html" class="glass-button" aria-label="Задать вопрос для Q&A">
                  <i class="fa-solid fa-question-circle"></i>
                  Задать вопрос
                </a>
                <a href="faq.html" class="glass-button" aria-label="Перейти к FAQ">
                  <i class="fa-solid fa-circle-question"></i>
                  FAQ
                </a>
              </div>
              <div class="mt-6 flex items-center gap-6 text-sm text-slate-600 dark:text-slate-300">
                <div class="flex items-center gap-2"><i class="fa-solid fa-users"></i>Подписчиков: <span id="subscriberCount" class="font-semibold">421</span></div>
                <div class="flex items-center gap-2"><i class="fa-solid fa-eye"></i>Просмотров: <span id="viewCount" class="font-semibold">147K</span></div>
              </div>
            </div>
            <div class="relative mt-8 lg:mt-0 fade-in">
              <video class="banner-video w-full max-w-full sm:max-w-md mx-auto rounded-3xl shadow-2xl ring-1 ring-slate-200 dark:ring-slate-700" loading="lazy" autoplay muted loop playsinline preload="metadata" aria-label="Аватар канала Mortis Play">
                <source src="/assets/photo.mp4" type="video/mp4" />
                <img src="/assets/fallback.jpg" alt="Видео недоступно" />
              </video>
              <img class="banner-fallback w-full max-w-full sm:max-w-md mx-auto rounded-3xl shadow-2xl ring-1 ring-slate-200 dark:ring-slate-700" src="/assets/photo.jpg" alt="Аватар канала Mortis Play" />
              <div class="banner-quote mt-4 lg:absolute lg:-bottom-4 lg:-right-4 bg-white/80 dark:bg-slate-900/80 glass rounded-2xl px-4 py-3 shadow card-hover lg:w-auto w-full">
                <p class="text-xs text-slate-600 dark:text-slate-300 text-center lg:text-left">Гений, миллиардер, плейбой, филантроп 😎</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="profile" class="py-16 fade-in">
  <div class="mx-auto max-w-7xl px-4">
    <h2 class="text-center text-2xl md:text-3xl font-bold">Твой профиль</h2>
    <p class="mt-2 text-center text-slate-600 dark:text-slate-300">Кастомизируй свой вайб и зарабатывай бейджи! 😎</p>
    <div class="mt-8 max-w-md mx-auto">
      <div class="card-hover rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-5">
        <h3 class="font-semibold text-indigo-600 dark:text-indigo-400">Аватар</h3>
        <img id="userAvatar" src="/assets/fallback.jpg" alt="Аватар пользователя" class="w-24 h-24 rounded-full mx-auto">
        <input type="file" id="avatarUpload" accept="image/*" class="mt-3 w-full rounded border border-slate-200 dark:border-slate-700 p-2">
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Загрузи свой аватар (до 1МБ).</p>
        <h3 class="mt-4 font-semibold text-indigo-600 dark:text-indigo-400">Имя пользователя</h3>
        <input type="text" id="usernameInput" maxlength="20" placeholder="Введи своё имя" class="mt-3 w-full rounded border border-slate-200 dark:border-slate-700 p-2 text-sm text-slate-700 dark:text-slate-300">
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Максимум 20 символов.</p>
        <h3 class="mt-4 font-semibold text-indigo-600 dark:text-indigo-400">Бейджи</h3>
        <div id="badges" class="flex flex-wrap gap-2"></div>
        <h3 class="mt-4 font-semibold text-indigo-600 dark:text-indigo-400">Доступные бейджи</h3>
        <div id="badgeList" class="mt-2 space-y-2"></div>
      </div>
    </div>
    <!-- Модальное окно для бейджей -->
    <div id="badgeModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full">
        <h3 id="modalTitle" class="font-semibold text-indigo-600 dark:text-indigo-400"></h3>
        <p id="modalDesc" class="mt-2 text-sm text-slate-600 dark:text-slate-300"></p>
        <button id="closeModal" class="mt-4 glass-button">Закрыть</button>
      </div>
    </div>
  </div>
</section>

      <section id="videos" class="py-16 fade-in">
        <div class="mx-auto max-w-7xl px-4">
          <h2 class="text-center text-2xl md:text-3xl font-bold">Мои видео</h2>
          <div class="mt-6 flex justify-center gap-3 flex-wrap">
            <button class="video-filter glass-button" data-filter="all" aria-label="Показать все видео" aria-pressed="true">Все</button>
            <button class="video-filter glass-button" data-filter="streams" aria-label="Показать стримы" aria-pressed="false">Стримы</button>
            <button class="video-filter glass-button" data-filter="fun" aria-label="Показать угарные видео" aria-pressed="false">Угар</button>
            <button class="video-filter glass-button" data-filter="blitz" aria-label="Показать БЛИЦ Play" aria-pressed="false">БЛИЦ Play</button>
          </div>
          <p id="category-desc" class="mt-2 text-center text-sm text-slate-600 dark:text-slate-300">Все видео от Mortis Play: стримы, мемы и подкасты!</p>
          <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <template id="ytCardTpl">
              <div class="video-card card-hover rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-4">
                <div class="relative aspect-video rounded-xl overflow-hidden">
                  <iframe class="w-full h-full" loading="lazy" allow="autoplay; encrypted-media" allowfullscreen title=""></iframe>
                  <img class="w-full h-full absolute top-0 left-0 object-cover hidden" src="/assets/fallback.jpg" alt="Видео недоступно" />
                </div>
                <p class="mt-3 text-sm text-slate-600 dark:text-slate-300"></p>
              </div>
            </template>
          </div>
          <div class="mt-6 text-center">
            <button id="loadMoreVideos" class="glass-button pagination-button" aria-label="Загрузить ещё видео">
              <i class="fa-solid fa-plus"></i> Загрузить ещё
            </button>
            <a href="https://www.youtube.com/@MortisPlay" target="_blank" class="glass-button" rel="noopener" aria-label="Смотреть все видео на YouTube">
              <i class="fa-brands fa-youtube"></i> Смотреть все видео
            </a>
          </div>
        </div>
      </section>

      <section id="projects" class="py-16 fade-in">
        <div class="mx-auto max-w-7xl px-4">
          <h2 class="text-center text-2xl md:text-3xl font-bold">Мои проекты</h2>
          <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div class="card-hover rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-5">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-indigo-600 dark:text-indigo-400">1 сезон «Типичный случай»</h3>
                <span class="text-xs px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-700">50%</span>
              </div>
              <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">Серия стримов с мемами и безумными челленджами.</p>
              <div class="mt-3 h-2 w-full rounded-full bg-slate-200 dark:bg-slate-700">
                <div class="h-full w-1/2 rounded-full bg-indigo-600" data-progress="50"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="news" class="py-16 fade-in">
        <div class="mx-auto max-w-7xl px-4">
          <h2 class="text-center text-2xl md:text-3xl font-bold">Новости</h2>
          <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Обновили немного сайт😎</h3>
              <p class="mt-2 text-sm">Вернули узоры на сайт, также обновили чуть чуть дизайн и обновили бота. Также, сообщаем вам новость о том, что сайт не будет обновляться в течение месяца, ведь мы сейчас начнем заниматься контентом поэтому все изменения которые у вас попадутся на сайте, будут исправлены только когда мы закончим с контентом, если вы обнаружите проблему на сайте, пишите в Telegram: <a href="https://t.me/dimap7221" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener">MortisPlay</a>. Приятного времяпровождение на сайте :3</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 25 сентября 2025</p>        
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Технический перерыв завершён!</h3>
              <p class="mt-2 text-sm">Йоу, геймеры! 🎮🔥 Сайт Mortis Play вернулся! Проверь новые фичи, обновления и Q&A. Пиши вопросы боту: <a href="https://t.me/MortisplayQABot" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener" onclick="gtag('event', 'button_click', {'event_category': 'News', 'event_label': 'Maintenance End Telegram'});">MortisplayQABot</a>. Следи за новостями в Telegram: <a href="https://t.me/MortisPlayTG" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener">@MortisPlayTG</a>.</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 22 сентября 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Новый раздел «Настройки» и бот готов!</h3>
              <p class="mt-2 text-sm">Йоу, геймеры! 🎮🔥 Новый раздел «Настройки» уже на сайте — настраивай тему, шрифты и производительность под себя! В будущем добавим ещё больше кастомизаций. 😎 Плюс, наш бот закончен и ждёт вопросов: <a href="https://t.me/MortisplayQABot" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener" onclick="gtag('event', 'button_click', {'event_category': 'News', 'event_label': 'Settings & Bot Telegram'});">MortisplayQABot</a>.</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 18 сентября 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Q&A открыт!</h3>
              <p class="mt-2 text-sm">Йоу, геймеры! 🎮🔥 Q&A стартовал! Пиши вопросы в Telegram: <a href="https://t.me/MortisplayQABot" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener" onclick="gtag('event', 'button_click', {'event_category': 'News', 'event_label': 'Q&A Telegram'});">MortisplayQABot</a>. Раздел «Видео» теперь с категориями (Все, Стримы, Угар). «FAQ» переехал на отдельную страницу. «Биография» получила новый стиль и плейлист! 🔥</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 15 сентября 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Улучшена Биография!</h3>
              <p class="mt-2 text-sm">Переработали страницу Биографии! Больше деталей о моём пути и планах. Проверь по кнопке "Биография"! 😎</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 10 сентября 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Редизайн сайта!</h3>
              <p class="mt-2 text-sm">Новый дизайн сайта: красивый, уникальный, обновлённый! Оцени и следи за апдейтами! 😎</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 19 августа 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Форум временно убран</h3>
              <p class="mt-2 text-sm">Спам-боты атаковали форум, поэтому мы его временно убрали. Планируем вернуть в августе с новым дизайном! Вопросы пока в Telegram: <a href="https://t.me/MortisplayQABot" class="underline text-indigo-600 dark:text-indigo-400" rel="noopener" onclick="gtag('event', 'button_click', {'event_category': 'News', 'event_label': 'Forum Telegram'});">MortisplayQABot</a>.</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 27 июля 2025</p>
            </article>
            <article class="card-hover rounded-2xl p-6">
              <h3 class="text-lg font-semibold">Новые мемы!</h3>
              <p class="mt-2 text-sm">Добавили 7 новых мемов! Проверь на сайте и удиви друзей! 😋</p>
              <p class="mt-3 text-xs">С любовью Mortis32 &lt;3 · 16 июля 2025</p>
            </article>
          </div>
        </div>
      </section>

      <section id="settings" class="py-16 fade-in">
        <div class="mx-auto max-w-7xl px-4">
          <h2 class="text-center text-2xl md:text-3xl font-bold">Настройки</h2>
          <p class="mt-2 text-center text-slate-600 dark:text-slate-300">Настрой сайт под себя для максимального комфорта! 😎</p>
          <div class="mt-8 max-w-md mx-auto">
            <div class="card-hover rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-5">
              <h3 class="font-semibold text-indigo-600 dark:text-indigo-400">Производительность</h3>
              <label class="mt-3 flex items-center gap-2">
                <input type="checkbox" id="lowPerformanceToggle" class="rounded text-indigo-600 focus:ring-indigo-500" aria-label="Включить лёгкий режим" aria-describedby="lowPerformanceDesc">
                <span class="text-sm text-slate-600 dark:text-slate-300">Лёгкий режим (для слабых устройств)</span>
              </label>
              <p id="lowPerformanceDesc" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Отключает анимации, эффекты и видео для плавной работы на слабых телефонах.</p>
              <label class="mt-3 flex items-center gap-2">
                <input type="checkbox" id="disableAnimationsToggle" class="rounded text-indigo-600 focus:ring-indigo-500" aria-label="Отключить анимации" aria-describedby="disableAnimationsDesc">
                <span class="text-sm text-slate-600 dark:text-slate-300">Отключить анимации</span>
              </label>
              <p id="disableAnimationsDesc" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Отключает только анимации для улучшения производительности.</p>
              <label class="mt-3 flex items-center gap-2">
                <input type="checkbox" id="disableParticlesToggle" class="rounded text-indigo-600 focus:ring-indigo-500" aria-label="Отключить фоновые частицы" aria-describedby="disableParticlesDesc">
                <span class="text-sm text-slate-600 dark:text-slate-300">Отключить фоновые частицы</span>
              </label>
              <p id="disableParticlesDesc" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Отключает фоновые частицы для повышения производительности.</p>
              <div id="performanceNotification" class="notification" role="alert" aria-live="assertive">
                <span></span>
                <button aria-label="Закрыть уведомление"><i class="fa-solid fa-xmark"></i></button>
              </div>
            </div>
            <div class="mt-6 card-hover rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-5">
              <h3 class="font-semibold text-indigo-600 dark:text-indigo-400">Внешний вид</h3>
              <label class="mt-3 flex items-center gap-2">
                <span class="text-sm text-slate-600 dark:text-slate-300">Тема сайта:</span>
                <select id="themeSelect" class="rounded text-indigo-600 focus:ring-indigo-500 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                  <option value="auto">Авто</option>
                  <option value="light">Светлая</option>
                  <option value="dark">Тёмная</option>
                </select>
              </label>
              <label class="mt-3 flex items-center gap-2">
                <input type="checkbox" id="highContrastToggle" class="rounded text-indigo-600 focus:ring-indigo-500" aria-label="Включить высокую контрастность" aria-describedby="highContrastDesc">
                <span class="text-sm text-slate-600 dark:text-slate-300">Высокая контрастность</span>
              </label>
              <p id="highContrastDesc" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Увеличивает контрастность для лучшей читаемости.</p>
              <label class="mt-3 flex flex-col gap-2">
                <span class="text-sm text-slate-600 dark:text-slate-300">Размер шрифта:</span>
                <input type="range" id="fontSizeSlider" min="50" max="200" value="100" class="w-full" aria-label="Регулировка размера шрифта" aria-valuemin="50" aria-valuemax="200" aria-valuenow="100">
              </label>
              <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Регулируй размер шрифта для удобства чтения (50%–200%).</p>
              <div id="appearanceNotification" class="notification" role="alert" aria-live="assertive">
                <span></span>
                <button aria-label="Закрыть уведомление"><i class="fa-solid fa-xmark"></i></button>
              </div>
            </div>
            <div class="mt-6 text-center">
              <button id="resetSettings" class="glass-button" aria-label="Сбросить настройки">
                <i class="fa-solid fa-rotate-left"></i> Сбросить настройки
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="contact" class="py-16 fade-in">
        <div class="mx-auto max-w-5xl px-4">
          <h2 class="text-center text-2xl md:text-3xl font-bold">Связь со мной</h2>
          <p class="mt-2 text-center text-slate-600 dark:text-slate-300">Хочешь коллаб или просто поболтать? Пиши!</p>
          <div class="mt-6 grid gap-6">
            <div class="rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 p-6">
              <ul class="space-y-2 text-slate-700 dark:text-slate-300">
                <li>Telegram: <a class="text-indigo-600 dark:text-indigo-400 underline" href="https://t.me/dimap7221" rel="noopener">MortisPlay</a></li>
                <li>Канал: <a class="text-indigo-600 dark:text-indigo-400 underline" href="https://t.me/MortisPlayTG" rel="noopener">@MortisPlayTG</a></li>
                <li>Бот: <a class="text-indigo-600 dark:text-indigo-400 underline" href="https://t.me/MortisplayQABot" rel="noopener">@MortisplayQABot</a></li>
                <li>Частный канал: <a class="text-indigo-600 dark:text-indigo-400 underline" href="https://t.me/+GqoVoVYJR185ZmYy" rel="noopener">Частный канал</a></li>
                <li>Email: <a class="text-indigo-600 dark:text-indigo-400 underline" href="mailto:mortisplay@mail.ru" rel="noopener">mortisplay@mail.ru</a></li>
              </ul>
              <div class="mt-4 flex flex-wrap gap-3">
                <a href="https://t.me/dimap7221" class="glass-button" rel="noopener" aria-label="Telegram Mortis Play"><i class="fa-brands fa-telegram"></i>Telegram</a>
                <a href="https://t.me/MortisPlayTG" class="glass-button" rel="noopener" aria-label="Telegram Channel Mortis Play"><i class="fa-brands fa-telegram"></i>Канал</a>
                <a href="https://t.me/MortisplayQABot" class="glass-button" rel="noopener" aria-label="Telegram Bot Mortis Play"><i class="fa-brands fa-telegram"></i>Бот</a>
                <a href="https://www.youtube.com/@MortisPlay" target="_blank" class="glass-button" rel="noopener" aria-label="YouTube Mortis Play"><i class="fa-brands fa-youtube"></i>YouTube</a>
                <a href="https://www.twitch.tv/mortisplay32" target="_blank" class="glass-button" rel="noopener" aria-label="Twitch Mortis Play"><i class="fa-brands fa-twitch"></i>Twitch</a>
                <a href="https://www.tiktok.com/@mortisplay32" target="_blank" class="glass-button" rel="noopener" aria-label="TikTok Mortis Play"><i class="fa-brands fa-tiktok"></i>TikTok</a>
                <a href="https://discord.gg/c7EmwzR4cX" target="_blank" class="glass-button" rel="noopener" aria-label="Discord Mortis Play"><i class="fa-brands fa-discord"></i>Discord</a>
              </div>
              <div class="mt-4">
                <a href="https://www.donationalerts.com/r/mortis32" target="_blank" class="glass-button" rel="noopener" aria-label="Поддержать проект Mortis Play"><i class="fa-solid fa-hand-holding-dollar"></i> Поддержать проект</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer class="border-t border-slate-200/60 dark:border-slate-700/60 py-8">
        <div class="mx-auto max-w-7xl px-4 flex flex-col sm:flex-row items-center justify-between gap-4">
          <p class="text-sm text-slate-600 dark:text-slate-300">© 2025 Mortis Play. Все права защищены.</p>
        </div>
      </footer>
    </main>

    <script nonce="${nonce}">
  const logAction = (message) => console.log(message);
const debounce = (func, wait) => {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
};

let lastNotificationTime = 0;
const showNotification = (message, notificationElement) => {
  const now = Date.now();
  if (now - lastNotificationTime < 10000) return;
  lastNotificationTime = now;
  if (notificationElement) {
    const span = notificationElement.querySelector('span');
    if (span) {
      document.querySelectorAll('.notification.show').forEach(el => el.classList.remove('show'));
      span.textContent = message;
      notificationElement.classList.add('show');
      gtag('event', 'notification_shown', { event_category: 'settings', event_label: message });
      const timeout = setTimeout(() => {
        notificationElement.classList.remove('show');
      }, 5000);
      const closeButton = notificationElement.querySelector('button');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          notificationElement.classList.remove('show');
          clearTimeout(timeout);
          gtag('event', 'notification_dismiss', { event_category: 'settings', event_label: 'dismiss_notification' });
          logAction('Уведомление закрыто');
        }, { once: true });
      }
    }
  }
};

const root = document.documentElement;

const setTheme = (theme, isPreview = false) => {
  try {
    logAction(`Тема установлена: ${theme}${isPreview ? ' (предпросмотр)' : ''}`);
    if (!isPreview) localStorage.setItem('theme', theme);
    root.classList.toggle('dark', theme === 'dark');
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      const themeIcon = themeToggle.querySelector('i');
      const themeText = themeToggle.querySelector('span');
      if (themeIcon && themeText) {
        themeIcon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        themeText.textContent = theme === 'dark' ? 'Тёмная' : 'Светлая';
      }
    }
    if (!isPreview) gtag('event', 'theme_toggle', { event_category: 'engagement', event_label: theme });
  } catch (e) {
    logAction('Ошибка в setTheme: ' + e.message);
  }
};

const setupThemeToggle = () => {
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const isDark = root.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    });
  }
};

const setupThemeSelect = () => {
  const themeSelect = document.getElementById('themeSelect');
  if (themeSelect) {
    let savedTheme;
    try {
      savedTheme = localStorage.getItem('theme') || 'auto';
    } catch (e) {
      savedTheme = 'auto';
      logAction('Ошибка чтения localStorage для theme: ' + e.message);
    }
    themeSelect.value = savedTheme;
    setTheme(savedTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : savedTheme);
    let previewTimeout;
    themeSelect.addEventListener('change', () => {
      const theme = themeSelect.value;
      const effectiveTheme = theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : theme;
      clearTimeout(previewTimeout);
      setTheme(effectiveTheme, true);
      showNotification(`Предпросмотр темы: ${theme === 'auto' ? 'Авто' : theme === 'light' ? 'Светлая' : 'Тёмная'}`, document.getElementById('appearanceNotification'));
      previewTimeout = setTimeout(() => {
        setTheme(effectiveTheme);
        showNotification(`Тема: ${theme === 'auto' ? 'Авто' : theme === 'light' ? 'Светлая' : 'Тёмная'}`, document.getElementById('appearanceNotification'));
        gtag('event', 'theme_select', { event_category: 'settings', event_label: theme });
        logAction(`Тема выбрана: ${theme}`);
      }, 2000);
    });
  }
};

const setupPerformance = () => {
  const toggle = document.getElementById('lowPerformanceToggle');
  const notification = document.getElementById('performanceNotification');
  if (toggle && notification) {
    let savedMode;
    try {
      savedMode = localStorage.getItem('lowPerformance') === 'true';
    } catch (e) {
      savedMode = false;
      logAction('Ошибка чтения localStorage для lowPerformance: ' + e.message);
    }
    toggle.checked = savedMode;
    root.classList.toggle('low-performance', savedMode);
    toggle.addEventListener('change', debounce(() => {
      const isLowPerformance = toggle.checked;
      try {
        localStorage.setItem('lowPerformance', isLowPerformance);
      } catch (e) {
        logAction('Ошибка записи localStorage для lowPerformance: ' + e.message);
      }
      root.classList.toggle('low-performance', isLowPerformance);
      showNotification(isLowPerformance ? 'Лёгкий режим включён' : 'Лёгкий режим выключен', notification);
      gtag('event', 'performance_toggle', { event_category: 'settings', event_label: isLowPerformance ? 'low' : 'normal' });
      logAction(`Режим производительности: ${isLowPerformance ? 'Лёгкий' : 'Нормальный'}`);
    }, 300));
  }
};

const setupAnimations = () => {
  const animationsToggle = document.getElementById('disableAnimationsToggle');
  const notification = document.getElementById('performanceNotification');
  if (animationsToggle && notification) {
    let savedAnimations;
    try {
      savedAnimations = localStorage.getItem('disableAnimations') === 'true';
    } catch (e) {
      savedAnimations = false;
      logAction('Ошибка чтения localStorage для disableAnimations: ' + e.message);
    }
    animationsToggle.checked = savedAnimations;
    root.classList.toggle('no-animations', savedAnimations);
    animationsToggle.addEventListener('change', debounce(() => {
      const disableAnimations = animationsToggle.checked;
      try {
        localStorage.setItem('disableAnimations', disableAnimations);
      } catch (e) {
        logAction('Ошибка записи localStorage для disableAnimations: ' + e.message);
      }
      root.classList.toggle('no-animations', disableAnimations);
      showNotification(disableAnimations ? 'Анимации отключены' : 'Анимации включены', notification);
      gtag('event', 'animations_toggle', { event_category: 'settings', event_label: disableAnimations ? 'off' : 'on' });
      logAction(`Анимации: ${disableAnimations ? 'Отключены' : 'Включены'}`);
    }, 300));
  }
};

const setupParticleToggle = () => {
  const toggle = document.getElementById('disableParticlesToggle');
  const notification = document.getElementById('performanceNotification');
  if (toggle && notification) {
    let savedParticles;
    try {
      savedParticles = localStorage.getItem('disableParticles') === 'true';
    } catch (e) {
      savedParticles = false;
      logAction('Ошибка чтения localStorage для disableParticles: ' + e.message);
    }
    toggle.checked = savedParticles;
    root.classList.toggle('no-particles', savedParticles);
    toggle.addEventListener('change', debounce(() => {
      const disableParticles = toggle.checked;
      try {
        localStorage.setItem('disableParticles', disableParticles);
      } catch (e) {
        logAction('Ошибка записи localStorage для disableParticles: ' + e.message);
      }
      root.classList.toggle('no-particles', disableParticles);
      showNotification(disableParticles ? 'Фоновые частицы отключены' : 'Фоновые частицы включены', notification);
      gtag('event', 'particles_toggle', { event_category: 'settings', event_label: disableParticles ? 'off' : 'on' });
      logAction(`Фоновые частицы: ${disableParticles ? 'Отключены' : 'Включены'}`);
    }, 300));
  }
};

const setupFontSize = () => {
  const slider = document.getElementById('fontSizeSlider');
  const notification = document.getElementById('appearanceNotification');
  if (slider && notification) {
    let savedFontSize;
    try {
      savedFontSize = localStorage.getItem('fontSize') || '100';
    } catch (e) {
      savedFontSize = '100';
      logAction('Ошибка чтения localStorage для fontSize: ' + e.message);
    }
    slider.value = savedFontSize;
    root.style.setProperty('--font-scale', savedFontSize / 100);
    slider.addEventListener('input', debounce(() => {
      const fontSize = slider.value;
      root.style.setProperty('--font-scale', fontSize / 100);
      showNotification(`Размер шрифта: ${fontSize}%`, notification);
      try {
        localStorage.setItem('fontSize', fontSize);
      } catch (e) {
        logAction('Ошибка записи localStorage для fontSize: ' + e.message);
      }
      gtag('event', 'font_size_change', { event_category: 'settings', event_label: fontSize });
      logAction(`Размер шрифта изменён: ${fontSize}%`);
    }, 300));
  }
};

const setupHighContrast = () => {
  const toggle = document.getElementById('highContrastToggle');
  const notification = document.getElementById('appearanceNotification');
  if (toggle && notification) {
    let savedHighContrast;
    try {
      savedHighContrast = localStorage.getItem('highContrast') === 'true';
    } catch (e) {
      savedHighContrast = false;
      logAction('Ошибка чтения localStorage для highContrast: ' + e.message);
    }
    toggle.checked = savedHighContrast;
    root.classList.toggle('high-contrast', savedHighContrast);
    toggle.addEventListener('change', debounce(() => {
      const highContrast = toggle.checked;
      try {
        localStorage.setItem('highContrast', highContrast);
      } catch (e) {
        logAction('Ошибка записи localStorage для highContrast: ' + e.message);
      }
      root.classList.toggle('high-contrast', highContrast);
      showNotification(highContrast ? 'Высокая контрастность включена' : 'Высокая контрастность выключена', notification);
      gtag('event', 'high_contrast_toggle', { event_category: 'settings', event_label: highContrast ? 'on' : 'off' });
      logAction(`Высокая контрастность: ${highContrast ? 'Включена' : 'Выключена'}`);
    }, 300));
  }
};

const setupResetSettings = () => {
  const resetButton = document.getElementById('resetSettings');
  const notification = document.getElementById('appearanceNotification');
  if (resetButton && notification) {
    resetButton.addEventListener('click', () => {
      localStorage.removeItem('theme');
      localStorage.removeItem('lowPerformance');
      localStorage.removeItem('disableAnimations');
      localStorage.removeItem('disableParticles');
      localStorage.removeItem('fontSize');
      localStorage.removeItem('highContrast');
      localStorage.removeItem('userAvatar');
      localStorage.removeItem('userBadges');
      localStorage.removeItem('username');
      localStorage.removeItem('watchedVideos');
      root.classList.remove('dark', 'low-performance', 'no-animations', 'no-particles', 'high-contrast');
      root.style.setProperty('--font-scale', '1');
      const themeSelect = document.getElementById('themeSelect');
      const lowPerformanceToggle = document.getElementById('lowPerformanceToggle');
      const animationsToggle = document.getElementById('disableAnimationsToggle');
      const particleToggle = document.getElementById('disableParticlesToggle');
      const fontSizeSlider = document.getElementById('fontSizeSlider');
      const highContrastToggle = document.getElementById('highContrastToggle');
      const userAvatar = document.getElementById('userAvatar');
      const usernameInput = document.getElementById('usernameInput');
      const badges = document.getElementById('badges');
      const badgeList = document.getElementById('badgeList');
      if (themeSelect) themeSelect.value = 'auto';
      if (lowPerformanceToggle) lowPerformanceToggle.checked = false;
      if (animationsToggle) animationsToggle.checked = false;
      if (particleToggle) particleToggle.checked = false;
      if (fontSizeSlider) fontSizeSlider.value = '100';
      if (highContrastToggle) highContrastToggle.checked = false;
      if (userAvatar) userAvatar.src = '/assets/fallback.jpg';
      if (usernameInput) usernameInput.value = '';
      if (badges) badges.innerHTML = '';
      if (badgeList) badgeList.innerHTML = '';
      setTheme('auto');
      setupBadges();
      showNotification('Настройки сброшены', notification);
      gtag('event', 'reset_settings', { event_category: 'settings', event_label: 'reset' });
      logAction('Настройки сброшены');
    });
  }
};

const setupProfile = () => {
  const avatarUpload = document.getElementById('avatarUpload');
  const userAvatar = document.getElementById('userAvatar');
  const usernameInput = document.getElementById('usernameInput');
  const badges = document.getElementById('badges');
  const badgeList = document.getElementById('badgeList');
  const notification = document.getElementById('appearanceNotification');

  if (avatarUpload && userAvatar && notification) {
    const savedAvatar = localStorage.getItem('userAvatar');
    if (savedAvatar) userAvatar.src = savedAvatar;
    avatarUpload.addEventListener('change', () => {
      const file = avatarUpload.files[0];
      if (file && file.size <= 1024 * 1024 && /^image\/(jpeg|png|gif|webp)$/.test(file.type)) {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.src = reader.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 100; // Ограничим размер для компрессии
            let width = img.width;
            let height = img.height;
            if (width > height && width > maxSize) {
              height *= maxSize / width;
              width = maxSize;
            } else if (height > maxSize) {
              width *= maxSize / height;
              height = maxSize;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            const compressed = canvas.toDataURL('image/jpeg', 0.8);
            userAvatar.src = compressed;
            localStorage.setItem('userAvatar', compressed);
            showNotification('Аватар обновлён', notification);
            gtag('event', 'avatar_upload', { event_category: 'profile', event_label: 'avatar_updated' });
            logAction('Аватар обновлён');
            checkBadgeConditions();
          };
        };
        reader.readAsDataURL(file);
      } else {
        showNotification('Выберите изображение (JPEG, PNG, GIF, WebP, до 1МБ)', notification);
        logAction('Ошибка загрузки аватара: неверный формат или размер');
      }
    });
  }

  if (usernameInput && notification) {
    const savedUsername = localStorage.getItem('username');
    if (savedUsername) usernameInput.value = savedUsername;
    usernameInput.addEventListener('input', debounce(() => {
      const username = usernameInput.value.trim();
      if (username.length <= 20) {
        localStorage.setItem('username', username);
        showNotification('Имя пользователя обновлено', notification);
        gtag('event', 'username_update', { event_category: 'profile', event_label: 'username_updated' });
        logAction(`Имя пользователя обновлено: ${username}`);
        checkBadgeConditions();
      } else {
        showNotification('Имя не должно превышать 20 символов', notification);
        logAction('Ошибка обновления имени: превышена длина');
      }
    }, 500));
  }

  if (badges && badgeList) {
    setupBadges();
  }

  // Для теста: сброс бейджей через консоль
  window.resetBadges = () => {
    localStorage.removeItem('userBadges');
    setupBadges();
    logAction('Бейджи сброшены через консоль');
  };
};

const setupBadges = () => {
  const badges = document.getElementById('badges');
  const badgeList = document.getElementById('badgeList');
  const notification = document.getElementById('appearanceNotification');
  if (!badges || !badgeList || !notification) return;

  const badgeDefinitions = [
    { name: 'Фанат', icon: 'fa-solid fa-star', description: 'Выдаётся за посещение сайта!', earned: () => true },
    { 
      name: 'Мемолог', 
      icon: 'fa-solid fa-laugh', 
      description: 'Посмотрите 4 видео в категории «Угар»', 
      earned: () => {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        return Object.values(watchedVideos).filter(v => v.category === 'fun').length >= 4;
      },
      progress: () => {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        return Math.min(Object.values(watchedVideos).filter(v => v.category === 'fun').length, 4);
      }
    },
    { name: 'Стример', icon: 'fa-solid fa-video', description: 'Загрузите аватар и установите имя пользователя', earned: () => {
      return !!localStorage.getItem('userAvatar') && !!localStorage.getItem('username');
    }},
    { name: 'Легенда', icon: 'fa-solid fa-crown', description: 'Получите все остальные бейджи', earned: () => {
      const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
      return savedBadges.includes('Фанат') && savedBadges.includes('Мемолог') && savedBadges.includes('Стример') && savedBadges.includes('Эпик Мемолог');
    }},
    { 
      name: 'Эпик Мемолог', 
      icon: 'fa-solid fa-trophy', 
      description: 'Просмотрите 50 видео в категории «Угар» (почти невозможно!)', 
      earned: () => {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        return Object.values(watchedVideos).filter(v => v.category === 'fun').length >= 50;
      },
      progress: () => {
        const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
        return Math.min(Object.values(watchedVideos).filter(v => v.category === 'fun').length, 50);
      }
    },
  ];

  const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
  
  // Очищаем и отображаем полученные бейджи
  badges.innerHTML = '';
  badgeDefinitions.forEach(badge => {
    if (savedBadges.includes(badge.name) || badge.earned()) {
      if (!savedBadges.includes(badge.name)) {
        savedBadges.push(badge.name);
        localStorage.setItem('userBadges', JSON.stringify(savedBadges));
        showNotification(`Новый бейдж: ${badge.name}!`, notification);
        gtag('event', 'badge_earned', { event_category: 'profile', event_label: badge.name });
        logAction(`Получен новый бейдж: ${badge.name}`);
      }
      const badgeEl = document.createElement('span');
      badgeEl.className = 'badge inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-600 text-white text-xs animate-[badgePop_0.5s_ease_forwards]';
      badgeEl.innerHTML = `<i class="${badge.icon}"></i>${badge.name}`;
      badges.appendChild(badgeEl);
    }
  });

  // Отображаем список всех бейджей с требованиями и прогрессом
  badgeList.innerHTML = '';
  badgeDefinitions.forEach((badge, index) => {
    const badgeItem = document.createElement('div');
    badgeItem.className = 'flex items-center gap-2 text-sm cursor-pointer';
    const status = savedBadges.includes(badge.name) || badge.earned() ? '✅' : '🔒';
    const progress = badge.progress ? `(${badge.progress()}/${badge.name === 'Мемолог' ? '4' : '50'})` : '';
    badgeItem.innerHTML = `
      <i class="${badge.icon} ${savedBadges.includes(badge.name) || badge.earned() ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400 dark:text-slate-600'}"></i>
      <span class="${savedBadges.includes(badge.name) || badge.earned() ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 dark:text-slate-600'}">${badge.name}: ${badge.description} ${progress}</span>
      <span>${status}</span>
    `;
    badgeList.appendChild(badgeItem);

    // Добавляем клик для модального окна с анимацией
    badgeItem.addEventListener('click', () => {
      const modal = document.getElementById('badgeModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalDesc = document.getElementById('modalDesc');
      if (modal && modalTitle && modalDesc) {
        modalTitle.textContent = badge.name;
        modalDesc.textContent = badge.description;
        modal.style.display = 'flex';
        modal.style.animation = 'modalFadeIn 0.3s ease forwards';
        document.getElementById('closeModal').addEventListener('click', () => {
          modal.style.animation = 'modalFadeOut 0.3s ease forwards';
          setTimeout(() => {
            modal.style.display = 'none';
          }, 300);
        }, { once: true });
      }
    });
  });
};

const checkBadgeConditions = () => {
  setupBadges(); // Проверяем и обновляем бейджи после каждого действия
};

const setupVideos = () => {
  const tpl = document.getElementById('ytCardTpl');
  const grid = document.querySelector('#videos .mt-8.grid');
  const loadMoreButton = document.getElementById('loadMoreVideos');
  const notification = document.getElementById('appearanceNotification');
  if (!tpl || !grid || !loadMoreButton || !notification) return;

  const videoData = [
    { src: 'https://rutube.ru/play/embed/17ab491deff35ceaacdbe027e266e9f6/', title: 'Угар в Content Warning', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/ea7fa319476924cad6ae44e7972f7f7e/', title: 'УГАР В REPO', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/46b92548cd13429c14348feb10dbd35d/', title: 'Игра CS2 (feat. Johnny Drill)', category: 'streams' },
    { src: 'https://rutube.ru/play/embed/2ba4872771e827b6ce560a8390462643/', title: 'ВРЕМЯ УГАРА И ПРЕДАТЕЛЬСТВА PEAK!', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/4e88d1d8cacec555ddb17bff2720394a/', title: 'Mortisplay32 ИГРАЕТ В PEAK', category: 'streams' },
    { src: 'https://rutube.ru/play/embed/3de912692f3520aad3ccf648b30f0247', title: 'ВРЕМЯ БЕЗУМИЙ В РАБОТЕ!!!', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/1cb1388800c0a573bb4c6942bc12c752', title: 'УМНЫЙ НО КОСОЙ', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/8e2f7da5ca6582d3b66ea73d39b53130', title: 'СПЕЦ ВЫПУСК!!! СМЕРТЕЛЬНЫЙ КОНТЕНТ!', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/f50e8d94d8228d9a8ffce5e37773a8e2', title: 'НОВЫЕ ВРЕМЕНА НАЧИНАЮТСЯ С РЕЛАКСА', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/522c3d4a29970e19b74f8cdfa9e2eb3e', title: 'СПЕЦ ВЫПУСК! ЧАС РАБОТЫ В ЛЕТАЛ КОМПАНИ!', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/2c266a516ea35150036cd6298ef6db68', title: 'ВРОДЕ ОБНОВА ТОП НО НЕ СОВСЕМ...', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/36faf3fd0b2c5dac09f907297925db41', title: 'НОВАЯ ВЕБКА, НОВЫЕ ГОРИЗОНТЫ!', category: 'fun' },
    { src: 'https://rutube.ru/play/embed/5b51c9a3e15b4d75bfb08783c90bcc85', title: 'БЛИЦ Play: КОНЕЦ ГОДА, ЧТО ДАЛЬШЕ?', category: 'blitz' },
    { src: 'https://rutube.ru/play/embed/171e2dae98076c82e5c49f3dfda7bb33', title: 'БЛИЦ Play: ПОСЛЕЖНИЙ РУБЕЖ!', category: 'blitz' },
    { src: 'https://rutube.ru/play/embed/0f958e52a3a7023734bfa562186a9bce', title: 'БЛИЦ Play: ВСЕ? ВСЕ.', category: 'blitz' }
  ];

  let currentPage = 1;
  const videosPerPage = 4;

  const renderVideos = (videos, append = false) => {
    if (!append) grid.innerHTML = '';
    videos.forEach((v) => {
      const node = tpl.content.cloneNode(true);
      const iframe = node.querySelector('iframe');
      const title = node.querySelector('p');
      const card = node.querySelector('.video-card');
      const fallbackImg = node.querySelector('img');
      if (iframe && title && card && fallbackImg) {
        iframe.src = v.src;
        iframe.setAttribute('title', `Видео: ${v.title}`);
        iframe.onload = () => {
          const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '{}');
          watchedVideos[v.title] = { category: v.category, watched: true };
          localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
          checkBadgeConditions();
        };
        iframe.onerror = () => {
          iframe.classList.add('hidden');
          fallbackImg.classList.remove('hidden');
          logAction(`Ошибка загрузки видео: ${v.title}`);
        };
        title.textContent = v.title;
        card.dataset.category = v.category;
        grid.appendChild(node);
      }
    });
    loadMoreButton.disabled = currentPage * videosPerPage >= videoData.length;
  };

  const loadMoreVideos = () => {
    currentPage++;
    const start = (currentPage - 1) * videosPerPage;
    const end = start + videosPerPage;
    const videosToShow = videoData.slice(start, end);
    renderVideos(videosToShow, true);
    gtag('event', 'load_more_videos', { event_category: 'videos', event_label: `page_${currentPage}` });
    logAction(`Загружено ещё ${videosToShow.length} видео`);
  };

  renderVideos(videoData.slice(0, videosPerPage));

  loadMoreButton.addEventListener('click', loadMoreVideos);

  const filterButtons = document.querySelectorAll('.video-filter');
  const categoryDesc = document.getElementById('category-desc');
  const categoryDescriptions = {
    all: 'Все видео от Mortis Play: стримы, мемы и подкасты!',
    streams: 'Стримы с эпичными моментами и геймплеем!',
    fun: 'Угарные видео и мемы для настроения!',
    blitz: 'Короткие и динамичные БЛИЦ Play ролики!'
  };

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filter = button.dataset.filter;
      filterButtons.forEach(btn => {
        btn.classList.toggle('active', btn === button);
        btn.setAttribute('aria-pressed', btn === button);
      });
      const filteredVideos = filter === 'all' ? videoData : videoData.filter(v => v.category === filter);
      currentPage = 1;
      renderVideos(filteredVideos.slice(0, videosPerPage));
      categoryDesc.textContent = categoryDescriptions[filter];
      gtag('event', 'video_filter', { event_category: 'videos', event_label: filter });
      logAction(`Фильтр видео: ${filter}`);
    });
  });
};

const setupNavigation = () => {
  const menuToggle = document.getElementById('menuToggle');
  const sidebarMenu = document.getElementById('sidebarMenu');
  const closeMenu = document.getElementById('closeMenu');
  if (menuToggle && sidebarMenu && closeMenu) {
    menuToggle.addEventListener('click', () => {
      sidebarMenu.classList.toggle('open');
      menuToggle.setAttribute('aria-expanded', sidebarMenu.classList.contains('open'));
      gtag('event', 'menu_toggle', { event_category: 'navigation', event_label: sidebarMenu.classList.contains('open') ? 'open' : 'close' });
      logAction(`Меню: ${sidebarMenu.classList.contains('open') ? 'Открыто' : 'Закрыто'}`);
    });
    closeMenu.addEventListener('click', () => {
      sidebarMenu.classList.remove('open');
      menuToggle.setAttribute('aria-expanded', 'false');
      gtag('event', 'menu_close', { event_category: 'navigation', event_label: 'close' });
      logAction('Меню закрыто');
    });
  }

  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = anchor.getAttribute('href').substring(1);
      const target = document.getElementById(targetId);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
        gtag('event', 'nav_click', { event_category: 'navigation', event_label: targetId });
        logAction(`Переход к секции: ${targetId}`);
      }
      if (sidebarMenu && sidebarMenu.classList.contains('open')) {
        sidebarMenu.classList.remove('open');
        menuToggle.setAttribute('aria-expanded', 'false');
      }
    });
  });
};

const setupParticles = () => {
  const canvas = document.getElementById('backgroundParticles');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const particles = [];
  const particleCount = Math.floor(window.innerWidth / 20);
  for (let i = 0; i < particleCount; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 3 + 1,
      speedX: Math.random() * 0.5 - 0.25,
      speedY: Math.random() * 0.5 - 0.25
    });
  }

  const animateParticles = () => {
    if (root.classList.contains('no-particles') || root.classList.contains('low-performance')) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += p.speedX;
      p.y += p.speedY;
      if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
      if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fillStyle = root.classList.contains('dark') ? '#e5e7eb' : '#1f2937';
      ctx.fill();
    });
    requestAnimationFrame(animateParticles);
  };

  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  animateParticles();
};

const setupFadeIn = () => {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
};

const setupVideoErrorHandling = () => {
  const video = document.querySelector('.banner-video');
  if (video) {
    video.addEventListener('error', () => {
      const fallbackImg = video.nextElementSibling;
      if (fallbackImg) {
        video.classList.add('hidden');
        fallbackImg.classList.remove('hidden');
        logAction('Ошибка загрузки видео в баннере');
      }
    });
  }
};

const setupLoader = () => {
  const loader = document.getElementById('loader');
  const siteContent = document.getElementById('siteContent');
  if (loader && siteContent) {
    const hideLoader = () => {
      loader.style.display = 'none';
      siteContent.classList.remove('hidden');
      gtag('event', 'page_load', { event_category: 'performance', event_label: 'site_loaded' });
      logAction('Сайт загружен');
    };
    window.addEventListener('load', () => {
      setTimeout(hideLoader, 500);
    });
    setTimeout(hideLoader, 10000);
  }
};

// Добавленный код для режима разработчика
const setupDevMode = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const isDev = urlParams.get('dev') === 'true';
  if (!isDev) {
    const profileSection = document.getElementById('profile');
    if (profileSection) {
      profileSection.style.display = 'none';
    }
    const profileLinks = document.querySelectorAll('a[href="#profile"]');
    profileLinks.forEach(link => {
      link.style.display = 'none';
    });
    logAction('Режим разработчика отключён: раздел "Профиль" скрыт');
  } else {
    logAction('Режим разработчика включён: раздел "Профиль" отображается');
  }
};

// Синхронизация localStorage для настроек (на случай нескольких вкладок)
window.addEventListener('storage', (e) => {
  if (e.key === 'theme') {
    setTheme(e.newValue);
  } else if (e.key === 'lowPerformance') {
    root.classList.toggle('low-performance', e.newValue === 'true');
  } else if (e.key === 'disableAnimations') {
    root.classList.toggle('no-animations', e.newValue === 'true');
  } else if (e.key === 'disableParticles') {
    root.classList.toggle('no-particles', e.newValue === 'true');
  } else if (e.key === 'fontSize') {
    root.style.setProperty('--font-scale', e.newValue / 100);
  } else if (e.key === 'highContrast') {
    root.classList.toggle('high-contrast', e.newValue === 'true');
  }
});

document.addEventListener('DOMContentLoaded', () => {
  setupDevMode(); // Вызываем новую функцию сразу после загрузки DOM
  setupThemeToggle();
  setupThemeSelect();
  setupPerformance();
  setupAnimations();
  setupParticleToggle();
  setupFontSize();
  setupHighContrast();
  setupResetSettings();
  setupProfile();
  setupVideos();
  setupNavigation();
  setupParticles();
  setupFadeIn();
  setupLoader();
  setupVideoErrorHandling();
});
</script>
</body>
</html>
