<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Mortis Play — Q&A</title>
<link rel="icon" href="/images/favicon.ico" />
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://kit.fontawesome.com/b48beda69e.js" crossorigin="anonymous" defer></script>
<style>
.glass-button { 
  background: rgba(255, 255, 255, 0.15); 
  backdrop-filter: blur(10px); 
  border: 1px solid rgba(255, 255, 255, 0.3); 
  border-radius: 0.75rem; 
  padding: 0.75rem 1.5rem; 
  color: #fff; 
  font-weight: 600; 
  transition: all 0.3s ease; 
}
.glass-button:hover { 
  background: rgba(255, 255, 255, 0.25); 
  transform: scale(1.05); 
}
.dark .glass-button { 
  background: rgba(50, 50, 50, 0.15); 
  border-color: rgba(200, 200, 200, 0.2); 
}
.fade-in { 
  opacity: 0; 
  transform: translateY(16px); 
  transition: opacity 0.6s ease, transform 0.6s ease; 
}
.fade-in.is-visible { 
  opacity: 1; 
  transform: none; 
}
.question-slide { 
  animation: slideIn 0.5s ease-out; 
}
@keyframes slideIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.blink { 
  animation: blink 1s step-end infinite; 
}
@keyframes blink {
  50% { opacity: 0; }
}
@media (max-width: 640px) { 
  .glass-button { 
    padding: 0.5rem 1rem; 
    font-size: 0.9rem; 
  } 
}
.success-message { color: #10b981; }
.error-message { color: #ef4444; }
textarea, input {
  color: #333; 
}
.dark textarea, .dark input {
  color: #d1d5db; 
}
textarea:focus, input:focus {
  outline: none;
  border-color: #3b82f6; 
}
.dark textarea:focus, .dark input:focus {
  border-color: #60a5fa; 
}
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  z-index: 1000;
  display: none;
}
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-indigo-50 dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 text-slate-800 dark:text-slate-100">
<div class="mx-auto max-w-7xl px-4 py-16">
  <!-- Кнопка "Вернуться на сайт" в шапке -->
  <div class="text-right mb-4">
    <a href="/index.html" class="glass-button">Вернуться на сайт</a>
  </div>

<h1 class="text-3xl font-bold text-center text-slate-900 dark:text-white">Q&A с Mortis Play</h1>
<p class="mt-4 text-center text-slate-600 dark:text-slate-300">Задавай вопросы — лучшие попадут в раздел после модерации!</p>

<!-- Форма -->
<div class="mt-8 max-w-lg mx-auto fade-in" id="qaFormContainer">
<form id="qaForm">
    <input type="text" name="nickname" id="nicknameInput" placeholder="Ваш никнейм" required class="w-full p-2 mb-2 border rounded bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200">
    <textarea name="question" id="questionInput" placeholder="Ваш вопрос" required class="w-full p-2 mb-2 border rounded bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200"></textarea>
    <button type="submit" class="glass-button">Отправить</button>
    <div id="questionLimit" class="mt-2 text-center text-sm text-slate-600 dark:text-slate-300"></div>
    <div id="submitStatus" class="mt-2 text-center"></div>
</form>
</div>

<!-- Панель модерации -->
<div id="moderationPanel" class="mt-8 max-w-lg mx-auto fade-in hidden">
<h2 class="text-xl font-semibold text-center text-slate-900 dark:text-white">Модерация вопросов <span id="pendingCount" class="blink text-red-500"></span></h2>
<ul id="pendingQuestions" class="mt-4 space-y-2"></ul>
<button id="clearApproved" class="glass-button mt-4 w-full">Очистить одобренные</button>
</div>

<!-- Список одобренных вопросов -->
<div id="qaList" class="mt-12 space-y-4 fade-in"></div>

<!-- Уведомление для пользователя -->
<div id="userNotification" class="notification"></div>
</div>

<script>
const isDevMode = new URLSearchParams(window.location.search).get('dev') === 'true';
if (isDevMode) document.getElementById('moderationPanel').style.display = 'block';

// Локальное хранение
let questions = JSON.parse(localStorage.getItem('qaQuestions')) || [];
const dailyLimit = 5;
const blackList = ['мат', 'оскорбление', 'спам', 'бот', 'чёрт', 'дурак']; // Черный список слов

// Элементы интерфейса
const questionLimit = document.getElementById('questionLimit');
const pendingCount = document.getElementById('pendingCount');
const userNotification = document.getElementById('userNotification');
let timerElement = null;

// Проверка лимитов и черного списка
function validateInput(nickname, question) {
    if (nickname.length < 3 || nickname.length > 20) return 'Никнейм должен быть от 3 до 20 символов!';
    if (question.length < 10 || question.length > 200) return 'Вопрос должен быть от 10 до 200 символов!';
    if (blackList.some(word => nickname.toLowerCase().includes(word) || question.toLowerCase().includes(word))) {
        return 'Сообщение содержит запрещённые слова!';
    }
    return null;
}

// Проверка дневного лимита и таймер сброса
function checkDailyLimit() {
    const today = new Date().toLocaleDateString();
    let dailyStats = JSON.parse(localStorage.getItem('qaDailyStats')) || {};
    const todayCount = dailyStats[today] || 0;
    const remaining = dailyLimit - todayCount;
    questionLimit.textContent = `Осталось: ${remaining} из ${dailyLimit}`;

    if (todayCount >= dailyLimit && !timerElement) {
        timerElement = document.createElement('span');
        timerElement.id = 'timer';
        questionLimit.appendChild(timerElement);
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const timeLeft = Math.floor((tomorrow - now) / 1000);
        updateTimer(timeLeft);
    } else if (todayCount < dailyLimit && timerElement) {
        if (timerElement.parentNode) timerElement.parentNode.removeChild(timerElement);
        timerElement = null;
    }

    if (todayCount >= dailyLimit) {
        return `Достигнут лимит в ${dailyLimit} вопросов за день! Сброс через: `;
    }
    dailyStats[today] = todayCount;
    localStorage.setItem('qaDailyStats', JSON.stringify(dailyStats));
    return null;
}

// Обновление таймера
function updateTimer(seconds) {
    if (!timerElement) return;
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    timerElement.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    if (seconds > 0) setTimeout(() => updateTimer(seconds - 1), 1000);
    else {
        const dailyStats = JSON.parse(localStorage.getItem('qaDailyStats')) || {};
        delete dailyStats[new Date().toLocaleDateString()];
        localStorage.setItem('qaDailyStats', JSON.stringify(dailyStats));
        timerElement.parentNode.removeChild(timerElement);
        timerElement = null;
        checkDailyLimit();
    }
}

// Показ уведомления пользователю
function showNotification(message, isSuccess = true) {
    userNotification.textContent = message;
    userNotification.className = 'notification ' + (isSuccess ? 'bg-green-600' : 'bg-red-600');
    userNotification.style.display = 'block';
    setTimeout(() => userNotification.style.display = 'none', 3000);
}

// Обработка формы
document.getElementById('qaForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const form = e.target;
    const nickname = document.getElementById('nicknameInput').value.trim();
    const question = document.getElementById('questionInput').value.trim();
    const date = new Date().toISOString(); // Сохраняем в ISO формате для корректного парсинга
    const submitStatus = document.getElementById('submitStatus');

    const validationError = validateInput(nickname, question);
    if (validationError) {
        submitStatus.textContent = validationError;
        submitStatus.classList.add('error-message');
        return;
    }

    const limitError = checkDailyLimit();
    if (limitError) {
        submitStatus.innerHTML = limitError + (timerElement ? timerElement.outerHTML : '');
        submitStatus.classList.add('error-message');
        return;
    }

    const today = new Date().toLocaleDateString();
    let dailyStats = JSON.parse(localStorage.getItem('qaDailyStats')) || {};
    dailyStats[today] = (dailyStats[today] || 0) + 1;
    localStorage.setItem('qaDailyStats', JSON.stringify(dailyStats));

    submitStatus.textContent = 'Отправка...';
    submitStatus.classList.remove('success-message', 'error-message');

    const newQuestion = { nickname, text: question, date, approved: false };
    questions.push(newQuestion);
    localStorage.setItem('qaQuestions', JSON.stringify(questions));

    submitStatus.textContent = 'Вопрос отправлен!';
    submitStatus.classList.add('success-message');
    form.reset();

    addQuestionToList(newQuestion.nickname, newQuestion.text, newQuestion.date);
    if (isDevMode) updatePendingQuestions();
});

// Добавление вопроса в список с анимацией
function addQuestionToList(nickname, question, date) {
    const qaList = document.getElementById('qaList');
    const div = document.createElement('div');
    div.className = 'p-4 bg-white dark:bg-slate-800 rounded-lg shadow question-slide';
    div.innerHTML = `<p class="question-text">${nickname}: ${question} <span class="text-xs text-slate-500 dark:text-slate-400">(${new Date(date).toLocaleString('ru-RU')})</span></p>`;
    qaList.insertBefore(div, qaList.firstChild);
    setTimeout(() => div.classList.add('is-visible'), 10);
}

// Обновление списка одобренных вопросов
function updateQAList() {
    const qaList = document.getElementById('qaList');
    qaList.innerHTML = '';
    const approvedQuestions = questions.filter(q => q.approved);
    if (approvedQuestions.length > 0) {
        approvedQuestions.forEach(q => {
            const div = document.createElement('div');
            div.className = 'p-4 bg-white dark:bg-slate-800 rounded-lg shadow question-slide';
            div.innerHTML = `<p class="question-text">${q.nickname}: ${q.text} <span class="text-xs text-slate-500 dark:text-slate-400">(${new Date(q.date).toLocaleString('ru-RU')})</span></p>`;
            qaList.appendChild(div);
            setTimeout(() => div.classList.add('is-visible'), 10);
        });
    } else {
        qaList.innerHTML = '<p class="text-center text-slate-600 dark:text-slate-300">Пока одобренных вопросов нет — ждём модерацию!</p>';
    }
}

// Обновление списка ожидающих вопросов и счётчика
function updatePendingQuestions() {
    if (!isDevMode) return;
    const pendingList = document.getElementById('pendingQuestions');
    pendingList.innerHTML = '';
    const pendingQuestions = questions.filter(q => !q.approved);
    pendingCount.textContent = pendingQuestions.length > 0 ? `(Ожидает: ${pendingQuestions.length})` : '';
    if (pendingQuestions.length > 0) {
        pendingQuestions.forEach((q, index) => {
            const li = document.createElement('li');
            li.className = 'p-2 bg-gray-100 dark:bg-gray-700 rounded';
            li.innerHTML = `<div class="flex justify-between items-center">
                <span class="question-text">${q.nickname}: ${q.text} <span class="text-xs text-slate-500 dark:text-slate-400">(${new Date(q.date).toLocaleString('ru-RU')})</span></span>
                <div>
                    <button class="glass-button text-xs px-2 py-1 mr-2" onclick="approveQuestion(${index})">Одобрить</button>
                    <button class="glass-button text-xs px-2 py-1" onclick="rejectQuestion(${index})">Отклонить</button>
                </div>
            </div>`;
            pendingList.appendChild(li);
        });
    } else {
        pendingList.innerHTML = '<p class="text-center text-slate-600 dark:text-slate-300">Все вопросы одобрены или ещё не отправлены.</p>';
    }
}

// Одобрение вопроса
function approveQuestion(index) {
    questions[index].approved = true;
    localStorage.setItem('qaQuestions', JSON.stringify(questions));
    updateQAList();
    updatePendingQuestions();
    showNotification(`Ваш вопрос "${questions[index].text}" одобрен!`, true);
}

// Отклонение вопроса
function rejectQuestion(index) {
    const rejectedQuestion = questions[index].text;
    questions.splice(index, 1);
    localStorage.setItem('qaQuestions', JSON.stringify(questions));
    updatePendingQuestions();
    showNotification(`Ваш вопрос "${rejectedQuestion}" отклонён.`, false);
}

// Очистка одобренных вопросов
document.getElementById('clearApproved')?.addEventListener('click', () => {
    questions = questions.filter(q => !q.approved);
    localStorage.setItem('qaQuestions', JSON.stringify(questions));
    updateQAList();
    updatePendingQuestions();
});

// Анимация появления
const io = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('is-visible'); });
}, { threshold: 0.1 });
document.querySelectorAll('.fade-in').forEach(el => io.observe(el));

// Инициализация
checkDailyLimit(); // Устанавливаем начальный счётчик
updateQAList();
if (isDevMode) updatePendingQuestions();
</script>
</body>
</html>
