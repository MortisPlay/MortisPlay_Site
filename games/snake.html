<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Змейка — Mortis Play</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#10b981;
      --muted:#94a3b8;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,var(--bg),#071021);color:#e6eef8}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative}
    .card{width:100%;max-width:960px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:grid;grid-template-columns:1fr 320px;gap:18px;position:relative}
    @media (max-width:900px){.card{grid-template-columns:1fr;max-width:420px}}
    .game-area{background:linear-gradient(180deg,#061024,#05101b);border-radius:10px;padding:12px;display:flex;align-items:center;justify-content:center;position:relative}
    canvas{background:#071226;border-radius:8px;display:block;max-width:100%;height:auto}

    /* === Оверлей Game Over === */
    #gameOverOverlay{
      position:absolute;inset:0;background:rgba(7,18,38,0.96);border-radius:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;
      opacity:0;pointer-events:none;z-index:20;transition:opacity .6s ease;
    }
    #gameOverOverlay.visible{opacity:1;pointer-events:all}

    .back-btn{
      background:var(--accent);color:#032018;padding:18px 48px;border-radius:14px;font-weight:800;
      font-size:22px;border:none;cursor:pointer;box-shadow:0 12px 40px rgba(16,185,129,0.5);
      transition:all .25s;
    }
    .back-btn:hover{transform:scale(1.08);box-shadow:0 16px 50px rgba(16,185,129,0.6)}

    .quest-badge{
      background:linear-gradient(135deg,#1e293b,#0f172a);padding:28px 56px;border-radius:24px;
      border:4px solid #10b981;box-shadow:0 0 60px rgba(16,185,129,0.6);
      text-align:center;color:#fff;animation:epicPulse 2.5s infinite;
    }
    .quest-badge h3{margin:0 0 12px;font-size:32px;font-weight:900}
    .quest-badge p{margin:0;font-size:20px;opacity:0.95}

    @keyframes epicPulse{
      0%,100%{box-shadow:0 0 60px rgba(16,185,129,0.6);transform:scale(1)}
      50%{box-shadow:0 0 90px rgba(16,185,129,1);transform:scale(1.05)}
    }

    .panel{padding:12px;background:rgba(255,255,255,0.02);border-radius:10px}
    h1{font-size:18px;margin:4px 0 8px}
    .score{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .pill{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;font-weight:600}
    .controls{display:flex;flex-direction:column;gap:8px}
    button{background:var(--accent);border:0;color:#032018;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{padding:8px;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .footer{margin-top:10px;font-size:13px;color:var(--muted)}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div>
        <div class="game-area" id="gameArea">
          <canvas id="gameCanvas" width="600" height="600" aria-label="Поле игры змейка"></canvas>

          <!-- Game Over + Бейджик -->
          <div id="gameOverOverlay">
            <div id="questBadge" class="quest-badge" style="display:none">
              <h3>ЗМЕИНЫЙ КОРОЛЬ!</h3>
              <p>Ты набрал 1000+ очков!</p>
            </div>
            <button class="back-btn" id="btnBack">Вернуться к играм</button>
            <div style="color:#94a3b8;font-size:18px">Финальный счёт: <span id="finalScore">0</span></div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button id="btnRestart" class="small">Новая игра</button>
          <button id="btnPause" class="small secondary">Пауза</button>
          <button id="btnSlow" class="small secondary">Сбросить рекорд</button>
        </div>
      </div>

      <aside class="panel">
        <h1>Змейка</h1>
        <div class="score">
          <div class="pill">Очки: <span id="score">0</span></div>
          <div class="pill">Лучший: <span id="best">0</span></div>
        </div>
        <div class="muted">Управление: стрелки / WASD / свайпы</div>
        <div class="controls">
          <label>Скорость (такт/сек)</label>
          <input id="speedRange" type="range" min="4" max="18" value="8">
          <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--muted)"><span>медленно</span><span>быстро</span></div>

          <label style="margin-top:8px">Размер сетки</label>
          <input id="gridRange" type="range" min="10" max="30" value="20">
          <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--muted)"><span>мелко</span><span>крупно</span></div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnToggleGrid" class="secondary small">Сетка</button>
            <button id="btnTheme" class="secondary small">Тема</button>
          </div>
        </div>
        <div class="footer">
          <div><strong>Легендарный бейдж:</strong> набрать 1000+ очков → «Змеиный Король»</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (function(){
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('gameOverOverlay');
    const questBadge = document.getElementById('questBadge');
    const finalScoreEl = document.getElementById('finalScore');
    const btnBack = document.getElementById('btnBack');

    // UI
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const btnRestart = document.getElementById('btnRestart');
    const btnPause = document.getElementById('btnPause');
    const btnResetBest = document.getElementById('btnSlow');

    let gridSize = 20;
    let cell = Math.floor(canvas.width / gridSize);
    let speed = 8;
    let snake = [];
    let dir = {x:1,y:0};
    let nextDir = {x:1,y:0};
    let food = null;
    let running = false;
    let paused = false;
    let score = 0;
    let best = parseInt(localStorage.getItem('snake_best') || '0', 10);
    bestEl.textContent = best;
    let showGrid = false;

    const QUEST_TARGET = 1000;  // Теперь 1000 очков!
    let questCompletedThisGame = false;

    let lastTime = 0;
    let acc = 0;

    function reset(){
      gridSize = parseInt(document.getElementById('gridRange').value, 10);
      cell = Math.floor(canvas.width / gridSize);
      snake = [];
      const startLen = 4;
      const startX = Math.floor(gridSize/2);
      const startY = Math.floor(gridSize/2);
      for(let i=0;i<startLen;i++) snake.push({x:startX-i,y:startY});
      dir = nextDir = {x:1,y:0};
      placeFood();
      score = 0; scoreEl.textContent = score;
      running = true; paused = false;
      document.getElementById('btnPause').textContent = 'Пауза';
      overlay.classList.remove('visible');
      questBadge.style.display = 'none';
      questCompletedThisGame = false;
    }

    function placeFood(){
      let x,y,tries=0;
      while(tries++<1000){
        x = Math.floor(Math.random()*gridSize);
        y = Math.floor(Math.random()*gridSize);
        if(!snake.some(s=>s.x===x && s.y===y)){ food = {x,y}; return; }
      }
      food = {x:0,y:0};
    }

    function tick(){
      dir = nextDir;
      const head = {x:snake[0].x + dir.x, y:snake[0].y + dir.y};

      if(head.x < 0) head.x = gridSize-1;
      if(head.y < 0) head.y = gridSize-1;
      if(head.x >= gridSize) head.x = 0;
      if(head.y >= gridSize) head.y = 0;

      if(snake.some((s,i)=>i>0 && s.x===head.x && s.y===head.y)){
        gameOver();
        return;
      }

      snake.unshift(head);

      if(food && head.x===food.x && head.y===food.y){
        score += Math.floor(10 + speed*0.5);
        scoreEl.textContent = score;

        // ЛЕГЕНДАРНЫЙ БЕЙДЖИК
        if(score >= QUEST_TARGET && !questCompletedThisGame){
          questCompletedThisGame = true;
          localStorage.setItem('badge_snake_king', 'unlocked');
        }

        placeFood();
        if(score > best){
          best = score;
          localStorage.setItem('snake_best', best);
          bestEl.textContent = best;
        }
      } else {
        snake.pop();
      }
    }

    function gameOver(){
      running = false;
      finalScoreEl.textContent = score;
      if(questCompletedThisGame){
        questBadge.style.display = 'block';
      }
      overlay.classList.add('visible');
    }

    // === ВСЁ ОСТАЛЬНОЕ (рисование, управление и т.д.) без изменений ===
    function draw(){ /* ... (оставил без изменений для краткости, но он полностью рабочий) ... */ }
    function roundRect(ctx,x,y,w,h,r){ /* ... */ }

    // Полный draw() — чтобы не было ошибок
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#071226';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      if(showGrid){
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        ctx.lineWidth = 1;
        for(let i=0;i<=gridSize;i++){
          const p = i*cell;
          ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,canvas.height); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(canvas.width,p); ctx.stroke();
        }
      }

      if(food){
        const fx = food.x*cell + cell*0.12;
        const fy = food.y*cell + cell*0.12;
        const size = cell*0.76;
        ctx.fillStyle = '#ef4444';
        roundRect(ctx,fx,fy,size,size,6);
        ctx.fill();
      }

      for(let i=snake.length-1;i>=0;i--){
        const s = snake[i];
        const x = s.x*cell, y = s.y*cell;
        if(i===0){
          ctx.fillStyle = '#10b981';
          roundRect(ctx,x+1,y+1,cell-2,cell-2,cell*0.15); ctx.fill();
          ctx.fillStyle = '#002018';
          ctx.beginPath(); ctx.arc(x + cell*0.65, y + cell*0.28, cell*0.06,0,Math.PI*2); ctx.fill();
        } else {
          const t = i / snake.length;
          ctx.fillStyle = `rgba(16,185,129,${0.6+0.4*(1-t)})`;
          roundRect(ctx,x+1,y+1,cell-2,cell-2,cell*0.12); ctx.fill();
        }
      }
    }

    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }

    function loop(ts){
      if(!lastTime) lastTime = ts;
      const dt = (ts-lastTime)/1000; lastTime = ts;
      acc += dt;
      const interval = 1/Math.max(1,parseInt(document.getElementById('speedRange').value,10));
      if(!paused && running){
        while(acc >= interval){ tick(); acc -= interval; }
      }
      draw();
      requestAnimationFrame(loop);
    }

    // Управление клавишами и свайпами (без изменений)
    window.addEventListener('keydown', e=>{
      if(['ArrowUp','w','W'].includes(e.key)) trySetDir(0,-1);
      if(['ArrowDown','s','S'].includes(e.key)) trySetDir(0,1);
      if(['ArrowLeft','a','A'].includes(e.key)) trySetDir(-1,0);
      if(['ArrowRight','d','D'].includes(e.key)) trySetDir(1,0);
      if(e.key===' ') { paused=!paused; btnPause.textContent=paused?'Продолжить':'Пауза'; }
    });

    function trySetDir(x,y){
      if(dir.x === -x && dir.y === -y) return;
      nextDir = {x,y};
    }

    let touchStart=null;
    canvas.addEventListener('touchstart', e=> { if(e.touches[0]) touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY}; }, {passive:true});
    canvas.addEventListener('touchend', e=> {
      if(!touchStart) return;
      const te = e.changedTouches[0];
      const dx = te.clientX-touchStart.x;
      const dy = te.clientY-touchStart.y;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>30) trySetDir(1,0); else if(dx<-30) trySetDir(-1,0);
      } else {
        if(dy>30) trySetDir(0,1); else if(dy<-30) trySetDir(0,-1);
      }
      touchStart=null;
    }, {passive:true});

    // Кнопки
    btnRestart.onclick = reset;
    btnPause.onclick = ()=>{ paused=!paused; btnPause.textContent=paused?'Продолжить':'Пауза'; };
    btnResetBest.onclick = ()=>{ if(confirm('Сбросить рекорд?')){ localStorage.removeItem('snake_best'); best=0; bestEl.textContent=best; }};
    
    // ВОТ ЭТО САМОЕ ВАЖНОЕ — кнопка теперь ведёт на страницу с играми!
    btnBack.onclick = () => {
      window.location.href = '/games/index.html';  // или '../' / 'games.html' — подстрой под свою структуру
    };

    document.getElementById('gridRange').oninput = reset;
    document.getElementById('btnToggleGrid').onclick = ()=>{ showGrid=!showGrid; document.getElementById('btnToggleGrid').textContent=showGrid?'Скрыть сетку':'Показать сетку'; };
    document.getElementById('btnTheme').onclick = ()=>{ document.documentElement.style.setProperty('--bg', getComputedStyle(document.documentElement).getPropertyValue('--bg')==='#0f1724'?'#f8fafc':'#0f1724'); };

    function fitCanvas(){
      const size = Math.min(canvas.parentElement.clientWidth, window.innerHeight-180);
      canvas.style.width = size+'px';
      canvas.style.height = size+'px';
      canvas.width = size * devicePixelRatio;
      canvas.height = size * devicePixelRatio;
      cell = Math.floor(canvas.width / gridSize);
    }

    window.addEventListener('resize',()=>{ fitCanvas(); draw(); });
    fitCanvas();
    reset();
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
